<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8"/>
		<title>Timer</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<meta property="og:title" content="Timer"/>
		<meta property="og:description" content="Simple onscreen timer"/> 
		<meta property="og:type" content="website"/>
		<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
		<link rel="manifest" href="site.webmanifest">
		<link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.css" rel="stylesheet"/>
		<link href="https://fonts.googleapis.com/css2?family=Fira+Code&display=swap" rel="stylesheet"> 
		<style type="text/css">
		html, body {
			height: 100vh;
			overflow: hidden;

			color: white;
		}

		body #help {
			opacity: 0;
		    transition: opacity 0.25s linear;
		}
		body.help #help {
			opacity: 1;
		}

		/* Theme */
		body {
			background-color: black;
		}

		#timer {
		    font-family: 'Fira Code', monospace;
		}

		#timer.ended {
			color: red;
			animation: blinker 1s linear infinite;
		}

		@keyframes blinker {
			50% {
				opacity: 0;
			}
		}
		</style>
	</head>
	<body class="help">
		<div class="grid grid-cols-1 grid-rows-1 justify-items-center items-center h-full">
			<div id="timer" class="text-9xl">00:00:00</div>
			<div id="help" class="absolute bottom-5 p-3 border rounded">
				<p>Enter desired time with <b>0-9</b> e.g 130 for 1 minutes and 30 seconds.<p>
				<p>Clear time with <b>c</b></p>
				<p>Start timer with <b>enter</b></p>
				<p>Stop timer with <b>q</b></p>
				<p>Toggle help with <b>h</b></p>
				<p>Toggle sound with <b>s</b></p>
			</div>
		</div>

		<script type="text/javascript">
		document.addEventListener('DOMContentLoaded', function() {
			const timer = document.getElementById('timer');
			const help = document.getElementById('help');

			const audio = new Audio('bicycle-horn-1.wav');

			let value = null;
			let end = null;

			if (window.location.hash) {
				value = window.location.hash.substr(1);
			} else {
				value = '00:01:00';
			}

			timer.innerHTML = format(value);

			// autostart timer
			if (window.obsstudio) {
				window.addEventListener('obsSourceVisibleChanged', function(event) {
					if (event.detail) {
						startTimer();
					} else {
						clearTimer();
					}
				});
			}

			let autohide = setTimeout(function() {
				document.body.classList.remove('help');
			}, 5000);

			document.onkeypress = function (e) {
				e.preventDefault();
				e.stopPropagation();

				// Cancel timer
				if (e.charCode === 113) { // q
					stopTimer();
				}

				// Clear timer
				if (e.charCode === 99) {
					clearTimer();
				}

				// Start timer
				if (e.charCode === 13) { // enter
					startTimer();
				}

				if (e.key === 'h') {
					toggleHelp();
				}

				if (e.key === 's') {
					if (document.body.classList.contains('sound')) {
						document.body.classList.remove('sound');
					} else {
						document.body.classList.add('sound');
					}
				}

				// Set timer
				if (e.charCode >= 48 && e.charCode <= 57) { // numbers
					value = format(value + String.fromCharCode(e.charCode));
					timer.innerHTML = value;
					timer.classList.remove('ended');

					window.location.hash = '#' + value;
				}
			}

			function startTimer() {
				const time = parse(value);
				end = (new Date().getTime() / 1000) + time.hours * 60 * 60 + time.minutes * 60 + time.seconds;
				timer.classList.remove('ended');
				window.requestAnimationFrame(showTime);
			}

			function stopTimer() {
				const urlParams = new URLSearchParams(window.location.search);
				let value = window.location.hash.substr(1);
				end = null;

				timer.classList.remove('ended');

				timer.innerHTML = format(value);
			}

			function endTimer() {
				timer.classList.add('ended');

				if (document.body.classList.contains('sound')) {
					audio.play();
				}
			}

			function clearTimer() {
				value = format("");
				timer.innerHTML = value;
				timer.classList.remove('ended');

				window.location.hash = '#' + value;
			}
		
			function showTime() {
				if (!end) {
					return;
				}

				const remaining = end - (new Date().getTime() / 1000);

				let s = 0, m = 0, h = 0;

				s = Math.ceil(remaining);
				
				m = Math.floor(s / 60);
				s = s % 60;

				h = Math.floor(m / 60);
				m = m % 60;

				s = s.toString().padStart(2, '0');
				m = m.toString().padStart(2, '0');
				h = h.toString().padStart(2, '0');

				timer.innerHTML = format([h, m, s].join(':'));
				if (end && remaining >= 0) {
					requestAnimationFrame(showTime);
				} else {
					endTimer();
				}
			}

			function parse(str) {
				const a = str.split(':');
				return {
					hours: parseInt(a[0]),
					minutes: parseInt(a[1]),
					seconds: parseInt(a[2]),
				}
			}

			function format(str) {
				return str.replace(/:/g, '').padStart(6, '0').slice(-6).replace(/(.{2})/g,"$1:").slice(0, -1);
			}

			function toggleHelp() {
				clearTimeout(autohide);
				if (document.body.classList.contains('help')) {
					document.body.classList.remove('help');
				} else {
					document.body.classList.add('help');
				}
			}
		});
		</script>
	</body>
</html>